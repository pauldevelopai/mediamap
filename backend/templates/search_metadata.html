{% extends "base.html" %}

{% block title %}Search Metadata{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('metadata.home') }}">Metadata</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Search</li>
                </ol>
            </nav>
            <h1>Search Metadata</h1>
            <p class="lead">Find and filter metadata entries</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">Search Filters</h5>
                </div>
                <div class="card-body">
                    <form id="search-form">
                        <div class="mb-3">
                            <label for="search-query" class="form-label">Search Query</label>
                            <input type="text" class="form-control" id="search-query" placeholder="Enter keywords">
                        </div>
                        <div class="mb-3">
                            <label for="content-type-filter" class="form-label">Content Type</label>
                            <select class="form-select" id="content-type-filter">
                                <option value="">All Types</option>
                                <option value="video">Video</option>
                                <option value="audio">Audio</option>
                                <option value="image">Image</option>
                                <option value="article">Article</option>
                                <option value="document">Document</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Categories</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="news" id="filter-news">
                                <label class="form-check-label" for="filter-news">News</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="entertainment" id="filter-entertainment">
                                <label class="form-check-label" for="filter-entertainment">Entertainment</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="education" id="filter-education">
                                <label class="form-check-label" for="filter-education">Education</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="sports" id="filter-sports">
                                <label class="form-check-label" for="filter-sports">Sports</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="technology" id="filter-technology">
                                <label class="form-check-label" for="filter-technology">Technology</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="business" id="filter-business">
                                <label class="form-check-label" for="filter-business">Business</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="date-from" class="form-label">Date From</label>
                            <input type="date" class="form-control" id="date-from">
                        </div>
                        <div class="mb-3">
                            <label for="date-to" class="form-label">Date To</label>
                            <input type="date" class="form-control" id="date-to">
                        </div>
                        <div class="mb-3">
                            <label for="sort-by" class="form-label">Sort By</label>
                            <select class="form-select" id="sort-by">
                                <option value="date-desc">Date (Newest First)</option>
                                <option value="date-asc">Date (Oldest First)</option>
                                <option value="title-asc">Title (A-Z)</option>
                                <option value="title-desc">Title (Z-A)</option>
                                <option value="relevance">Relevance</option>
                            </select>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Search</button>
                            <button type="button" class="btn btn-outline-secondary mt-2" id="reset-filters">Reset Filters</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Search Results</h5>
                    <span class="badge bg-primary" id="result-count">0 results</span>
                </div>
                <div class="card-body">
                    <div id="search-results">
                        <p class="text-center py-5">Use the filters to search for metadata</p>
                    </div>
                    <div id="pagination" class="d-flex justify-content-center mt-4">
                        <!-- Pagination will be added by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('search-form');
    const resetButton = document.getElementById('reset-filters');
    const resultsContainer = document.getElementById('search-results');
    const resultCount = document.getElementById('result-count');
    
    // Reset filters
    resetButton.addEventListener('click', function() {
        searchForm.reset();
        resultsContainer.innerHTML = '<p class="text-center py-5">Use the filters to search for metadata</p>';
        resultCount.textContent = '0 results';
    });
    
    // Handle search form submission
    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get search parameters
        const query = document.getElementById('search-query').value;
        const contentType = document.getElementById('content-type-filter').value;
        const dateFrom = document.getElementById('date-from').value;
        const dateTo = document.getElementById('date-to').value;
        const sortBy = document.getElementById('sort-by').value;
        
        // Get selected categories
        const categories = [];
        document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
            categories.push(checkbox.value);
        });
        
        // Create search parameters object
        const searchParams = {
            query,
            contentType,
            categories,
            dateFrom,
            dateTo,
            sortBy
        };
        
        // Show loading state
        resultsContainer.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-3">Searching metadata...</p></div>';
        
        // Send search request
        fetch('/metadata/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(searchParams)
        })
        .then(response => response.json())
        .then(data => {
            if (data.length === 0) {
                resultsContainer.innerHTML = '<p class="text-center py-5">No results found. Try different search criteria.</p>';
                resultCount.textContent = '0 results';
                return;
            }
            
            // Update result count
            resultCount.textContent = `${data.length} results`;
            
            // Display results
            resultsContainer.innerHTML = '<div class="list-group"></div>';
            const listGroup = resultsContainer.querySelector('.list-group');
            
            data.forEach(item => {
                const listItem = document.createElement('a');
                listItem.href = item.url || '#';
                listItem.className = 'list-group-item list-group-item-action';
                listItem.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">${item.title}</h5>
                        <small>${new Date(item.publishDate).toLocaleDateString()}</small>
                    </div>
                    <p class="mb-1">${item.description || 'No description available'}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            ${item.contentType} | by ${item.author || 'Unknown'}
                        </small>
                        <div>
                            ${item.categories.map(cat => `<span class="badge bg-secondary me-1">${cat}</span>`).join('')}
                        </div>
                    </div>
                `;
                listGroup.appendChild(listItem);
            });
            
            // Add simple pagination if needed
            if (data.length > 10) {
                const pagination = document.getElementById('pagination');
                pagination.innerHTML = `
                    <nav>
                        <ul class="pagination">
                            <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item"><a class="page-link" href="#">Next</a></li>
                        </ul>
                    </nav>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            resultsContainer.innerHTML = '<p class="text-center py-5 text-danger">An error occurred while searching. Please try again.</p>';
        });
    });
});
</script>
{% endblock %} 