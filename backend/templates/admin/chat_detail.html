{% extends "admin/base_admin.html" %}

{% block title %}Chat Details | MediaMap Admin{% endblock %}

{% block header %}Chat Details: {{ chat.title or 'Untitled Chat' }}{% endblock %}

{% block content %}
<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold">Chat Information</h6>
        <div>
            <button class="btn btn-sm btn-success me-2" onclick="extractFacts({{ chat.id }})">
                <i class="bi bi-file-text"></i> Extract Company Info
            </button>
            <button class="btn btn-sm btn-warning me-2" onclick="developStrategies({{ chat.id }})">
                <i class="bi bi-lightbulb"></i> Develop Strategies
            </button>
            <a href="{{ url_for('admin_chats') }}" class="btn btn-sm btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Chats
            </a>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Chat ID
                        <span class="badge bg-primary rounded-pill">{{ chat.id }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Title
                        <span>{{ chat.title or 'Untitled Chat' }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Created
                        <span>{{ chat.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                    </li>
                </ul>
            </div>
            <div class="col-md-6">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        User
                        {% if chat.user_id %}
                        <a href="{{ url_for('admin_user_detail', user_id=chat.user_id) }}">
                            {{ chat.user.username if chat.user else 'Unknown User' }}
                        </a>
                        {% else %}
                        <span class="text-muted">Anonymous User</span>
                        {% endif %}
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Messages
                        <span class="badge bg-primary rounded-pill">{{ messages|length }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Last Updated
                        <span>{{ chat.updated_at.strftime('%Y-%m-%d %H:%M') }}</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Company Info & Strategies Section -->
<div class="row mb-4">
    <!-- Company Facts -->
    <div class="col-md-6">
        <div class="card shadow h-100">
            <div class="card-header py-3 bg-success text-white">
                <h6 class="m-0 font-weight-bold"><i class="bi bi-file-text me-2"></i>Company Information</h6>
            </div>
            <div class="card-body">
                <div id="fact-sheet-content">
                    {% if chat.fact_sheet %}
                    <div class="alert alert-success">
                        <pre style="white-space: pre-wrap; margin: 0;">{{ chat.fact_sheet }}</pre>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>No company information extracted yet.
                        <br><small>Click "Extract Company Info" to analyze this conversation.</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Strategies -->
    <div class="col-md-6">
        <div class="card shadow h-100">
            <div class="card-header py-3 bg-warning text-dark">
                <h6 class="m-0 font-weight-bold"><i class="bi bi-lightbulb me-2"></i>Business Strategies</h6>
            </div>
            <div class="card-body">
                <div id="strategies-content">
                    {% if chat.strategies %}
                    <div class="alert alert-warning">
                        <pre style="white-space: pre-wrap; margin: 0;">{{ chat.strategies }}</pre>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>No strategies developed yet.
                        <br><small>Extract company info first, then develop strategies.</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold">Chat Messages</h6>
    </div>
    <div class="card-body">
        <div class="chat-container p-3" style="max-height: 600px; overflow-y: auto;">
            {% for message in messages %}
            <div class="chat-message mb-3 {% if message.role == 'user' %}user-message{% else %}assistant-message{% endif %}">
                <div class="card {% if message.role == 'user' %}bg-light border-primary{% else %}bg-primary text-white{% endif %}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>
                            <strong>{{ message.role|title }}</strong>
                        </span>
                        <small>{{ message.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                    </div>
                    <div class="card-body">
                        <div class="message-content">
                            {{ message.content|nl2br }}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .user-message {
        margin-left: 20%;
    }
    
    .assistant-message {
        margin-right: 20%;
    }
    
    .message-content {
        white-space: pre-wrap;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 2s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
async function extractFacts(chatId) {
    const button = event.target;
    const originalText = button.innerHTML;
    const factSheetContent = document.getElementById('fact-sheet-content');
    
    // Show loading state
    button.disabled = true;
    button.innerHTML = '<span class="loading-spinner me-2"></span>Extracting...';
    factSheetContent.innerHTML = `
        <div class="alert alert-info">
            <span class="loading-spinner me-2"></span>Analyzing conversation and extracting company information...
        </div>
    `;
    
    try {
        const response = await fetch('/extract_facts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ chat_id: chatId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            factSheetContent.innerHTML = `
                <div class="alert alert-success">
                    <pre style="white-space: pre-wrap; margin: 0;">${data.fact_sheet}</pre>
                </div>
            `;
            
            // Show success toast
            showToast('Company information extracted successfully!', 'success');
        } else {
            factSheetContent.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>Error: ${data.error}
                </div>
            `;
            showToast('Failed to extract company information.', 'error');
        }
    } catch (error) {
        factSheetContent.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>Network error. Please try again.
            </div>
        `;
        showToast('Network error occurred.', 'error');
    } finally {
        // Restore button state
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

async function developStrategies(chatId) {
    const button = event.target;
    const originalText = button.innerHTML;
    const strategiesContent = document.getElementById('strategies-content');
    
    // Show loading state
    button.disabled = true;
    button.innerHTML = '<span class="loading-spinner me-2"></span>Developing...';
    strategiesContent.innerHTML = `
        <div class="alert alert-info">
            <span class="loading-spinner me-2"></span>Analyzing company information and developing strategies...
        </div>
    `;
    
    try {
        const response = await fetch('/develop_strategies', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ chat_id: chatId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            strategiesContent.innerHTML = `
                <div class="alert alert-warning">
                    <pre style="white-space: pre-wrap; margin: 0;">${data.strategies}</pre>
                </div>
            `;
            
            // Show success toast
            showToast('Business strategies developed successfully!', 'success');
        } else {
            strategiesContent.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>Error: ${data.error}
                </div>
            `;
            showToast('Failed to develop strategies.', 'error');
        }
    } catch (error) {
        strategiesContent.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>Network error. Please try again.
            </div>
        `;
        showToast('Network error occurred.', 'error');
    } finally {
        // Restore button state
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

function showToast(message, type) {
    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    const toastId = 'toast-' + Date.now();
    const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';
    
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    const toast = new bootstrap.Toast(document.getElementById(toastId));
    toast.show();
    
    // Remove toast element after it's hidden
    document.getElementById(toastId).addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1055';
    document.body.appendChild(container);
    return container;
}
</script>
{% endblock %} 